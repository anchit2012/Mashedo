<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DesiGems | Discover Hindi Streamers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #8b5cf6; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans min-h-screen flex flex-col">

    <nav class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-900/95 sticky top-0 z-50 backdrop-blur">
        <div class="flex items-center gap-2">
            <span class="text-2xl">ðŸ‡®ðŸ‡³</span>
            <h1 class="text-2xl font-bold tracking-tighter text-orange-400">DESI<span class="text-white">GEMS</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <button id="logout-btn" onclick="logout()" class="hidden text-sm text-slate-400 hover:text-white underline">Logout</button>
            <button id="login-btn" onclick="loginWithTwitch()" class="bg-purple-600 hover:bg-purple-700 text-white px-5 py-2 rounded-lg font-bold transition flex items-center gap-2 shadow-lg shadow-purple-900/20">
                Login with Twitch
            </button>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-6 w-full flex-grow grid grid-cols-1 lg:grid-cols-12 gap-8 mt-4">
        
        <div class="lg:col-span-8 space-y-4">
            <div class="relative w-full pt-[56.25%] bg-black rounded-xl overflow-hidden shadow-2xl border border-slate-800">
                <div id="twitch-embed" class="absolute top-0 left-0 w-full h-full">
                    <div class="flex flex-col items-center justify-center h-full text-slate-500 bg-slate-900">
                        <span class="text-4xl mb-4">ðŸ“º</span>
                        <p class="text-lg">Connect Twitch to find Hindi streamers</p>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800 p-4 md:p-6 rounded-xl border border-slate-700 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-center md:text-left">
                    <h2 id="streamer-name" class="text-xl font-bold text-white truncate max-w-md">Ready?</h2>
                    <p id="viewer-count" class="text-slate-400 text-sm">Waiting for input...</p>
                </div>
                <div class="flex gap-3 w-full md:w-auto">
                    <button id="vote-btn" onclick="voteStreamer()" disabled class="flex-1 md:flex-none bg-slate-700 text-slate-400 px-6 py-3 rounded-lg font-bold transition flex items-center justify-center gap-2 group cursor-not-allowed">
                        <span class="group-hover:-translate-y-1 transition-transform">â–²</span> Vote
                    </button>
                    <button id="find-btn" onclick="getRandomStreamer()" disabled class="flex-1 md:flex-none bg-slate-700 text-slate-500 cursor-not-allowed px-6 py-3 rounded-lg font-bold transition flex items-center justify-center gap-2">
                        Next Desi ðŸŽ²
                    </button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-4 space-y-6">
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 h-full flex flex-col">
                <div class="flex justify-between items-end mb-6">
                    <h3 class="text-xl font-bold flex items-center gap-2">ðŸ”¥ Leaderboard</h3>
                    <span class="text-xs text-orange-400 uppercase font-bold tracking-wider">Session</span>
                </div>
                
                <div id="leaderboard-list" class="space-y-3 flex-grow overflow-y-auto max-h-[500px]">
                    <div class="text-center text-slate-500 py-10 italic">
                        No votes yet today.<br>Be the first to vote!
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- CONFIG ---
        const CLIENT_ID = 't2vgijkp48wmupnrxr76wg26unrjqf'; 
        const REDIRECT_URI = window.location.href.split('#')[0]; 
        
        // --- STATE ---
        let accessToken = null;
        let currentStreamer = null; // Stores info about the currently playing streamer
        let leaderboardData = [];   // Stores our local leaderboard

        // --- 1. AUTHENTICATION (Now with Auto-Save) ---
        function loginWithTwitch() {
            const scope = 'user:read:email';
            const authUrl = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${scope}`;
            window.location.href = authUrl;
        }

        function initAuth() {
            // A. Check URL for new token (User just logged in)
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);

            if (params.has('access_token')) {
                accessToken = params.get('access_token');
                // Save to browser storage
                localStorage.setItem('twitch_token', accessToken);
                // Clean the URL (remove ugly hash)
                window.history.replaceState({}, document.title, window.location.pathname);
                setLoggedInUI();
            } 
            // B. Check Local Storage (User refreshed page)
            else if (localStorage.getItem('twitch_token')) {
                accessToken = localStorage.getItem('twitch_token');
                setLoggedInUI();
            }
        }

        function setLoggedInUI() {
            const loginBtn = document.getElementById('login-btn');
            loginBtn.innerHTML = `âœ… Connected`;
            loginBtn.classList.replace('bg-purple-600', 'bg-green-600');
            loginBtn.disabled = true;

            document.getElementById('logout-btn').classList.remove('hidden');

            const findBtn = document.getElementById('find-btn');
            findBtn.disabled = false;
            findBtn.classList.replace('bg-slate-700', 'bg-purple-600');
            findBtn.classList.replace('text-slate-500', 'text-white');
            findBtn.innerText = "Find Desi Streamer ðŸŽ²";
        }

        function logout() {
            localStorage.removeItem('twitch_token');
            window.location.reload();
        }

        // --- 2. SEARCH LOGIC (Indian Filter) ---
        async function getRandomStreamer() {
            if (!accessToken) return alert("Please log in!");

            // UI Updates
            const btn = document.getElementById('find-btn');
            const voteBtn = document.getElementById('vote-btn');
            
            btn.innerText = "Scanning India...";
            btn.disabled = true;
            voteBtn.disabled = true;
            voteBtn.classList.add('cursor-not-allowed', 'bg-slate-700', 'text-slate-400');
            voteBtn.classList.remove('bg-green-600', 'text-white', 'hover:bg-green-700');

            try {
                // 1. Get Top Games
                const gamesRes = await fetch('https://api.twitch.tv/helix/games/top?first=100', {
                    headers: { 'Client-ID': CLIENT_ID, 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (gamesRes.status === 401) { logout(); return; } // Token expired? Logout.
                
                const gamesData = await gamesRes.json();
                const randomGame = gamesData.data[Math.floor(Math.random() * (gamesData.data.length - 5)) + 5];

                console.log(`Checking ${randomGame.name}...`);
                document.getElementById('streamer-name').innerText = `Scanning: ${randomGame.name}...`;

                // 2. Get Hindi Streams
                const streamsRes = await fetch(`https://api.twitch.tv/helix/streams?game_id=${randomGame.id}&first=100&language=hi`, {
                    headers: { 'Client-ID': CLIENT_ID, 'Authorization': `Bearer ${accessToken}` }
                });
                const streamsData = await streamsRes.json();

                // 3. Filter Low Viewers
                const underrated = streamsData.data.filter(s => s.viewer_count < 50 && s.viewer_count > 0);

                if (underrated.length > 0) {
                    const pick = underrated[Math.floor(Math.random() * underrated.length)];
                    loadStream(pick, randomGame.name);
                } else {
                    console.log("No match, retrying...");
                    setTimeout(() => getRandomStreamer(), 500); // Retry loop
                }

            } catch (err) {
                console.error(err);
                btn.innerText = "Try Again ðŸŽ²";
                btn.disabled = false;
            }
        }

        function loadStream(streamData, gameName) {
            // Save current streamer to state
            currentStreamer = {
                name: streamData.user_name,
                login: streamData.user_login,
                game: gameName,
                viewers: streamData.viewer_count
            };

            // Build Iframe
            const container = document.getElementById('twitch-embed');
            const currentHost = window.location.hostname;
            container.innerHTML = `<iframe src="https://player.twitch.tv/?channel=${currentStreamer.login}&parent=${currentHost}&muted=false" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>`;

            // Update Text
            document.getElementById('streamer-name').innerText = currentStreamer.name;
            document.getElementById('viewer-count').innerHTML = `<span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> ${currentStreamer.viewers} Viewers â€¢ Playing ${currentStreamer.game}`;

            // Enable Buttons
            const btn = document.getElementById('find-btn');
            btn.innerText = "Next Desi ðŸŽ²";
            btn.disabled = false;

            const voteBtn = document.getElementById('vote-btn');
            voteBtn.disabled = false;
            voteBtn.classList.remove('cursor-not-allowed', 'bg-slate-700', 'text-slate-400');
            voteBtn.classList.add('bg-slate-700', 'text-white', 'hover:bg-green-600');
        }

        // --- 3. LEADERBOARD SYSTEM ---
        function voteStreamer() {
            if (!currentStreamer) return;

            // Check if already in leaderboard
            const existing = leaderboardData.find(s => s.name === currentStreamer.name);
            
            if (existing) {
                existing.votes++;
            } else {
                leaderboardData.push({ ...currentStreamer, votes: 1 });
            }

            // Sort by votes (Highest first)
            leaderboardData.sort((a, b) => b.votes - a.votes);

            renderLeaderboard();
            
            // Visual feedback on button
            const btn = document.getElementById('vote-btn');
            btn.innerText = "Voted! âœ“";
            btn.classList.add('bg-green-600');
            setTimeout(() => {
                btn.innerText = "Vote â–²";
                btn.classList.remove('bg-green-600');
            }, 1000);
        }

        function renderLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = ""; // Clear current list

            leaderboardData.forEach((item, index) => {
                const rank = index + 1;
                const html = `
                    <div class="flex items-center gap-4 bg-slate-700/50 p-3 rounded-lg border border-slate-700/50 fade-in">
                        <div class="text-xl font-bold ${rank === 1 ? 'text-yellow-400' : 'text-slate-500'}">#${rank}</div>
                        <div class="overflow-hidden">
                            <div class="font-bold text-white truncate">${item.name}</div>
                            <div class="text-xs text-slate-400 truncate">Playing ${item.game}</div>
                        </div>
                        <div class="ml-auto font-mono font-bold text-orange-400 bg-orange-900/30 px-2 py-1 rounded">${item.votes} â–²</div>
                    </div>
                `;
                list.innerHTML += html;
            });
        }

        // Start App
        window.onload = initAuth;
    </script>
</body>
</html>
