<script>
    const CLIENT_ID = 'YOUR_TWITCH_CLIENT_ID'; // Public
    const REDIRECT_URI = 'https://yourusername.github.io/your-repo-name/'; 
    let accessToken = null;

    // 1. Function to send user to Twitch to login
    function loginWithTwitch() {
        const url = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=user:read:email`;
        window.location.href = url;
    }

    // 2. Check if we just returned from Twitch with a token
    function checkUrlForToken() {
        const hash = window.location.hash;
        if (hash) {
            const params = new URLSearchParams(hash.substring(1));
            accessToken = params.get('access_token');
            if (accessToken) {
                console.log("Token acquired!");
                // Clean the URL so the token doesn't stay in the bar
                window.history.replaceState({}, document.title, window.location.pathname);
                return true;
            }
        }
        return false;
    }

    // 3. The Logic to find a streamer with < 30 viewers
    async function getRandomStreamer() {
        if (!accessToken) return alert("Please Login with Twitch first!");

        // We fetch 'Just Chatting' streams (Game ID: 509658)
        // We set 'first=100' to get a big batch
        const response = await fetch('https://api.twitch.tv/helix/streams?game_id=509658&first=100', {
            headers: {
                'Client-ID': CLIENT_ID,
                'Authorization': `Bearer ${accessToken}`
            }
        });

        const data = await response.json();
        
        // Filter the list for streamers with < 30 viewers
        const underrated = data.data.filter(s => s.viewer_count < 30 && s.viewer_count > 2);

        if (underrated.length > 0) {
            const randomPick = underrated[Math.floor(Math.random() * underrated.length)];
            loadStream(randomPick.user_login);
        } else {
            alert("No underrated streamers found in this batch. Try again!");
        }
    }

    function loadStream(username) {
        document.getElementById('twitch-embed').innerHTML = "";
        new Twitch.Embed("twitch-embed", {
            width: "100%",
            height: "100%",
            channel: username,
            parent: [window.location.hostname] // This fixes the "refused to connect" error
        });
        document.getElementById('streamer-name').innerText = username;
    }

    window.onload = () => {
        checkUrlForToken();
    };
</script>
